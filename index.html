<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>布药厅_music</title>
    <style>
        /* 字体定义 */
        @font-face {
            font-family: 'PingFang Medium';
            src: local('PingFang SC'), local('Microsoft YaHei'), sans-serif;
            font-weight: normal;
            font-style: normal;
        }

        :root { 
            --bg-color: #000000; 
            --glass-bg: rgba(20, 30, 45, 0.7);
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
            --text-main: #FFFFFF; 
            --text-sub: #94a3b8; 
            --ui-accent: #00FF99; 
            --netease-red: #ff4d4d;
            --qq-green: #00e676;

            --card-width: 360px;
            --card-height: 520px;
            --gap: 20px;
        }

        * { -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'PingFang Medium', 'PingFang SC', -apple-system, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            margin: 0; 
            height: 100vh; 
            height: 100dvh; 
            overflow: hidden; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* === 背景 === */
        .background-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(circle at 50% 50%, #0e2a47 0%, #000000 85%);
            overflow: hidden;
        }

        @keyframes liquid-float {
            0% { transform: translate3d(0, 110vh, 0) rotate(0deg); }
            50% { transform: translate3d(20px, 50vh, 0) rotate(5deg); }
            100% { transform: translate3d(-20px, -20vh, 0) rotate(-5deg); }
        }
        .pill-wrapper { position: absolute; top: 0; will-change: transform; }
        .pill { 
            width: 100%; height: 100%; border-radius: 999px; 
            display: flex; justify-content: center; align-items: center; 
            border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.01);
        }
        .pill span { font-size: 13px; font-weight: 800; letter-spacing: 1px; color: rgba(255,255,255,0.3); }

        /* === Logo 样式 === */
        .top-left-logo { 
            position: fixed; top: 30px; left: 30px; width: 50px; z-index: 100; opacity: 0.9; 
            filter: drop-shadow(0 0 10px rgba(0,255,153,0.3));
        }
        .text-logo-fallback {
            position: fixed; top: 35px; left: 30px; z-index: 100;
            font-size: 18px; font-weight: 900; color: #fff; letter-spacing: 2px;
            display: none;
            text-shadow: 0 0 10px var(--ui-accent);
        }

        /* === 布局核心 === */
        .stage-wrapper {
            position: relative; 
            width: var(--card-width); 
            height: var(--card-height);
            transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); 
            display: flex; 
            justify-content: center;
            max-width: 100vw;
        }

        /* --- 标题修复关键样式 --- */
        .app-header { 
            position: absolute; 
            top: -60px; 
            width: 100%; /* 跟随父容器宽度 */
            text-align: center; 
            transition: opacity 0.3s; 
            z-index: 20; /* 确保在最上层 */
        }
        .app-header h1 { 
            font-size: 28px; margin: 0; letter-spacing: 2px; font-weight: 800; 
            color: #fff; text-shadow: 0 0 25px rgba(0, 255, 153, 0.2); 
        }

        /* === 面板通用 === */
        .panel {
            position: absolute; top: 0; width: var(--card-width); height: 100%;
            background: var(--glass-bg); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
            border: var(--glass-border); border-radius: 24px; 
            box-sizing: border-box;
            display: flex; flex-direction: column;
            transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .control-panel { 
            left: 0; z-index: 10; padding: 25px; 
            box-shadow: 0 30px 60px rgba(0,0,0,0.6); 
        }
        
        .result-panel { 
            opacity: 0; transform: scale(0.95); pointer-events: none;
            background: rgba(15, 23, 42, 0.95);
            left: 0; z-index: 5;
        }

        /* === 桌面端布局 === */
        @media (min-width: 769px) {
            .stage-wrapper.expanded { 
                width: calc(var(--card-width) * 2 + var(--gap)); 
            }
            .stage-wrapper.expanded .result-panel {
                left: auto; right: 0; opacity: 1; transform: scale(1); pointer-events: auto;
                box-shadow: 0 30px 60px rgba(0,0,0,0.6);
            }
            .back-btn { display: none; }
        }

        /* === 移动端适配 === */
        @media (max-width: 768px) {
            :root { --card-width: 90vw; --card-height: 80vh; }
            .stage-wrapper.expanded .control-panel { opacity: 0; transform: scale(0.9); pointer-events: none; }
            .stage-wrapper.expanded .result-panel { opacity: 1; transform: scale(1); pointer-events: auto; z-index: 20; box-shadow: 0 0 50px rgba(0,0,0,0.8); left: 0; }
            .app-header { top: -50px; }
            .app-header h1 { font-size: 24px; }
            .top-left-logo { width: 30px; top: 20px; left: 20px; }
            .text-logo-fallback { font-size: 14px; top: 25px; left: 20px; }
        }

        /* === 组件 === */
        .input-group { margin-bottom: 15px; }
        .input-label { font-size: 10px; color: var(--text-sub); font-weight: 700; letter-spacing: 1px; margin-bottom: 6px; text-transform: uppercase; display: block; }
        
        .date-loader-box { position: relative; border-radius: 14px; padding: 2px; background: rgba(255,255,255,0.05); overflow: hidden; }
        .date-loader-box::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: conic-gradient(transparent 0deg, transparent 270deg, var(--ui-accent) 360deg);
            animation: spin 1.5s linear infinite; opacity: 0; transition: opacity 0.3s;
        }
        .date-loader-box.loading::before { opacity: 1; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        #date-input {
            position: relative; z-index: 2; width: 100%; box-sizing: border-box;
            background-color: #0f172a; border: none; border-radius: 12px; padding: 12px;
            text-align: center; font-size: 20px; font-weight: bold; letter-spacing: 3px; color: #fff;
            background-image: linear-gradient(to right, rgba(0, 255, 153, 0.2), rgba(0, 255, 153, 0.2));
            background-size: 0% 100%; background-repeat: no-repeat; transition: background-size 0.4s ease-out;
        }

        .styled-input {
            width: 100%; box-sizing: border-box; background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px;
            color: #fff; font-size: 14px; font-weight: 500; transition: 0.2s;
            -webkit-appearance: none;
        }
        .styled-input:focus { outline: none; border-color: var(--ui-accent); background: rgba(0,0,0,0.4); }
        .styled-input.flash-success { animation: successPulse 0.6s ease-out; border-color: var(--ui-accent); color: var(--ui-accent); }
        @keyframes successPulse { 0% { border-color: #fff; } 100% { border-color: var(--ui-accent); } }

        .cookie-wrapper { border: 1px dashed rgba(255,255,255,0.2); border-radius: 12px; padding: 2px; background: rgba(0,0,0,0.3); }
        details > summary { padding: 10px; font-size: 11px; color: #888; cursor: pointer; list-style: none; font-weight: 700; }
        .cookie-textarea {
            width: 100%; height: 60px; background: transparent; border: none;
            color: var(--ui-accent); font-family: 'PingFang Medium', monospace; font-size: 10px;
            padding: 8px; box-sizing: border-box; resize: none;
        }
        .cookie-textarea:focus { outline: none; }

        .btn-pill-action {
            margin-top: auto; width: 100%; padding: 14px; border-radius: 50px; border: none;
            background: var(--ui-accent); color: #000; font-size: 16px; font-weight: 900; letter-spacing: 2px;
            cursor: pointer; transition: 0.2s; box-shadow: 0 0 20px rgba(0, 255, 153, 0.3);
            -webkit-appearance: none;
        }
        .btn-pill-action:hover { transform: scale(1.02); }
        .btn-pill-action:active { transform: scale(0.96); }
        .btn-pill-action:disabled { background: #333; color: #555; box-shadow: none; cursor: wait; }

        .mode-toggle { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 4px; display: flex; position: relative; }
        .mode-bg { position: absolute; top: 4px; left: 4px; width: calc(50% - 4px); height: calc(100% - 8px); background: rgba(255,255,255,0.15); border-radius: 7px; transition: transform 0.3s; }
        .mode-btn { flex: 1; text-align: center; padding: 8px 0; font-size: 11px; font-weight: 700; color: #888; cursor: pointer; z-index: 2; transition: color 0.3s; }
        .mode-btn.active { color: #fff; }

        /* === 结果列表 === */
        .result-header {
            padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 11px; font-weight: 700; color: var(--ui-accent); text-transform: uppercase; letter-spacing: 1px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .back-btn { cursor: pointer; padding: 5px 10px; background: rgba(255,255,255,0.1); border-radius: 6px; color: #fff; }
        .result-count { background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 10px; color: #fff; font-size: 11px; }

        .result-scroll-area { flex: 1; overflow-y: auto; padding: 15px; -webkit-overflow-scrolling: touch; }

        .song-card {
            display: flex; align-items: center;
            padding: 10px; margin-bottom: 10px; border-radius: 12px;
            background: rgba(255,255,255,0.03); border: 1px solid transparent;
            transition: 0.2s; position: relative; overflow: hidden;
        }
        .song-card:active { background: rgba(255,255,255,0.08); }
        .song-card.copied { animation: border-flash 0.4s ease; border-color: var(--ui-accent); }
        @keyframes border-flash { 0% { border-color: rgba(0, 255, 153, 0.2); } 50% { border-color: rgba(0, 255, 153, 1); } 100% { border-color: var(--ui-accent); } }

        .cover-wrapper { position: relative; width: 44px; height: 44px; margin-right: 12px; flex-shrink: 0; cursor: zoom-in; }
        .album-art { width: 100%; height: 100%; border-radius: 6px; background: #222; object-fit: cover; }
        
        .copy-toast {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); color: var(--ui-accent);
            display: flex; justify-content: center; align-items: center;
            font-size: 9px; font-weight: 900; 
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
            border-radius: 6px; backdrop-filter: blur(1px);
        }
        .song-card.copied .copy-toast { opacity: 1; }

        .song-meta { flex: 1; min-width: 0; cursor: text; }
        .s-title { font-size: 14px; font-weight: 700; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .s-artist { font-size: 12px; color: #888; margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-family: monospace; }
        
        .s-year { 
            font-size: 11px; font-weight: 800; padding: 4px 6px; border-radius: 6px; 
            font-family: monospace; margin-left: 10px; border: 1px solid transparent;
        }
        .year-wy { background: rgba(255, 58, 58, 0.15); color: var(--netease-red); border-color: rgba(255, 58, 58, 0.3); }
        .year-qq { background: rgba(0, 230, 118, 0.15); color: var(--qq-green); border-color: rgba(0, 230, 118, 0.3); }

        /* === 高清封面弹窗 === */
        .cover-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 200;
            backdrop-filter: blur(10px);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        .cover-modal.active { opacity: 1; pointer-events: auto; }
        
        .cover-box {
            background: rgba(20, 30, 45, 0.8); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px; padding: 25px; text-align: center;
            width: 80%; max-width: 400px;
            box-shadow: 0 0 60px rgba(0,255,153,0.05);
            transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .cover-modal.active .cover-box { transform: scale(1); }

        .hd-cover { width: 100%; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .cover-title { color: #fff; font-size: 16px; font-weight: 700; margin-bottom: 5px; }
        .cover-artist { color: var(--ui-accent); font-size: 12px; margin-bottom: 20px; font-family: monospace; }

        .cover-btn { 
            background: var(--ui-accent); color: #000; padding: 12px 24px; border-radius: 50px; 
            text-decoration: none; font-weight: 800; display: inline-block; cursor: pointer; border:none;
            letter-spacing: 1px; text-transform: uppercase; font-size: 12px; width: 100%; box-sizing: border-box;
        }
        
        .close-modal { position: absolute; top: 15px; right: 20px; color: rgba(255,255,255,0.5); font-size: 28px; cursor: pointer; }
        .hint-text { font-size: 10px; color: #555; text-align: center; margin-top: 10px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="background-layer" id="bg-layer"></div>

    <!-- LOGO 图片 -->
    <img src="logo.png" class="top-left-logo" alt="Logo" onerror="this.style.display='none'; document.getElementById('text-fallback').style.display='block'">
    <div id="text-fallback" class="text-logo-fallback">布药厅</div>

    <div class="stage-wrapper" id="stage">

        <!-- 关键修改：标题移到这里，作为 stage-wrapper 的子元素，但独立于 panel -->
        <div class="app-header"><h1>布药厅_music</h1></div>

        <!-- 控制面板 -->
        <div class="control-panel panel">
            <!-- 标题已移除，放到上面了 -->

            <div class="input-group" style="margin-top: 20px;">
                <label class="input-label">Date (MM-DD)</label>
                <div class="date-loader-box" id="date-loader-box">
                    <input type="text" id="date-input" value="07-23">
                </div>
            </div>

            <div class="input-group">
                <label class="input-label">Engine Mode</label>
                <div class="mode-toggle">
                    <div class="mode-bg" id="mode-bg"></div>
                    <div class="mode-btn active" onclick="setMode(1)">PLAYLIST ID</div>
                    <div class="mode-btn" onclick="setMode(2)">DUAL-ENGINE</div>
                </div>
            </div>

            <div class="input-group">
                <label class="input-label" id="param-label">Target ID</label>
                <input type="text" id="param-input" class="styled-input" value="167659726">
            </div>

            <div class="input-group">
                <label class="input-label">Config Protocol</label>
                <div class="cookie-wrapper">
                    <details>
                        <summary>Access Cookie (Folded)</summary>
                        <textarea id="cookie-input" class="cookie-textarea" placeholder="Paste Cookie here..."></textarea>
                    </details>
                </div>
            </div>

            <button id="btn-submit" class="btn-pill-action" onclick="handleSearch()">Pill</button>
            <div class="hint-text">Tap Cover for HD / Tap Text to Copy</div>
        </div>

        <!-- 结果面板 -->
        <div class="result-panel panel">
            <div class="result-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span class="back-btn" onclick="goBack()">⬅ BACK</span>
                    <span id="status-text">Ready</span>
                </div>
                <span id="res-count" class="result-count">0</span>
            </div>
            <div class="result-scroll-area" id="result-list"></div>
        </div>
    </div>

    <!-- Cover Modal -->
    <div class="cover-modal" id="coverModal" onclick="closeCoverModal(event)">
        <div class="cover-box">
            <div class="close-modal" onclick="closeCoverModal(event, true)">×</div>
            <img src="" class="hd-cover" id="modalImg">
            <div class="cover-title" id="modalTitle"></div>
            <div class="cover-artist" id="modalArtist"></div>
            <a href="#" target="_blank" class="cover-btn" id="modalLink">Save HD Image</a>
        </div>
    </div>

    <script>
        // API 列表
        const API_URLS = [
            "https://netease-cloud-music-api-beta-lyart.vercel.app",
            "https://music.163.com/api/v1",
            "https://ncmapi.ikaoli.cn",
            "https://apis.netstart.cn/music",
            "https://netease-cloud-music-api.vercel.app",
            "https://music-api.heheda.top",
            "https://cloud-music-api.plumbiu.com"
        ];

        let currentMode = 1;
        let workingApiUrl = API_URLS[0];

        // --- 初始化背景动画 ---
        function initBackground() {
            const bg = document.getElementById('bg-layer');
            const dates = ["01-01", "02-14", "03-08", "04-01", "05-20", "06-18", "07-07", "08-01", "09-10", "10-24", "11-11", "12-25"];
            
            for(let i=0; i<15; i++) {
                const text = dates[Math.floor(Math.random() * dates.length)];
                const left = Math.random() * 120 - 10;
                const width = Math.floor(Math.random() * 40) + 50;
                const dur = Math.random() * 50 + 40;
                const delay = Math.random() * -50;
                const blur = Math.random() > 0.5 ? 2 : 1;
                const dir = Math.random() > 0.5 ? 'normal' : 'reverse';
                
                const div = document.createElement('div');
                div.className = 'pill-wrapper';
                div.style.cssText = `
                    left: ${left}vw; width: ${width}px; height: ${width*0.4}px;
                    filter: blur(${blur}px); opacity: ${Math.random()*0.1 + 0.05};
                    animation: liquid-float ${dur}s ease-in-out infinite ${delay}s ${dir};
                `;
                div.innerHTML = `<div class="pill"><span>${text}</span></div>`;
                bg.appendChild(div);
            }
        }
        initBackground();

        // --- 自动提取ID ---
        document.getElementById('param-input').addEventListener('input', function() {
            if (currentMode !== 1) return; 
            const val = this.value;
            const idMatch = val.match(/id=(\d+)/) || val.match(/\/playlist\/(\d+)/);
            if (idMatch) {
                this.value = idMatch[1];
                this.classList.add('flash-success');
                setTimeout(() => this.classList.remove('flash-success'), 600);
            }
        });

        function setMode(m) {
            currentMode = m;
            document.getElementById('mode-bg').style.transform = m === 1 ? 'translateX(0%)' : 'translateX(100%)';
            document.querySelectorAll('.mode-btn')[0].classList.toggle('active', m === 1);
            document.querySelectorAll('.mode-btn')[1].classList.toggle('active', m === 2);
            document.getElementById('param-label').innerText = m === 1 ? "TARGET ID" : "KEYWORD";
            const input = document.getElementById('param-input');
            if (m === 1) {
                input.placeholder = "Paste Link / Enter ID";
                if(!input.value) input.value = "167659726";
            } else {
                input.placeholder = "Song / Artist / Album";
                if(input.value === "167659726") input.value = "";
            }
        }

        function setStatus(msg, count='') {
            document.getElementById('status-text').innerText = msg;
            document.getElementById('res-count').innerText = count;
        }

        function setLoadingState(isLoading) {
            const box = document.getElementById('date-loader-box');
            if(isLoading) { box.classList.add('loading'); } 
            else { box.classList.remove('loading'); document.getElementById('date-input').style.backgroundSize = '0% 100%'; }
        }

        function setProgress(percent) {
            const el = document.getElementById('date-input');
            el.style.backgroundSize = `${percent}% 100%`;
        }

        function copyToClipboard(text, el) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try { document.execCommand('copy'); } catch (err) {}
            document.body.removeChild(textArea);

            el.classList.add('copied'); 
            setTimeout(() => el.classList.remove('copied'), 800);
        }

        function openCoverModal(url, title, artist) {
            const hdUrl = url.split('?')[0];
            document.getElementById('modalImg').src = hdUrl;
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalArtist').innerText = artist;
            document.getElementById('modalLink').href = hdUrl;
            document.getElementById('coverModal').classList.add('active');
        }

        function closeCoverModal(e, force=false) {
            if(force || e.target.id === 'coverModal') {
                document.getElementById('coverModal').classList.remove('active');
            }
        }
        
        function goBack() {
            document.getElementById('stage').classList.remove('expanded');
        }

        function getCookieParams() {
            const v = document.getElementById('cookie-input').value.trim();
            return v ? `&cookie=${encodeURIComponent(v)}` : '';
        }

        async function fetchJson(url) {
            const c = new AbortController();
            const id = setTimeout(() => c.abort(), 20000);
            try {
                const r = await fetch(url + (url.includes('?')?'':'?') + getCookieParams(), { signal: c.signal });
                clearTimeout(id);
                return await r.json();
            } catch(e) { clearTimeout(id); throw e; }
        }

        async function getWorkingApi() {
            setStatus("Linking...");
            for (let u of API_URLS) {
                try {
                    const r = await fetchJson(u + '/search?keywords=test&limit=1');
                    if (r.code === 200) { workingApiUrl = u; return u; }
                } catch(e){}
            }
            throw new Error("Netease API Offline");
        }

        async function fetchNeteasePlaylist(id) {
            const base = workingApiUrl || await getWorkingApi();
            setStatus("Indexing...");
            const r = await fetchJson(`${base}/playlist/detail?id=${id}`);
            if(!r.playlist) throw new Error("No Data");
            const ids = r.playlist.trackIds.map(t=>t.id);
            setStatus(`Scanning ${ids.length} Nodes...`);
            let songs = [];
            for(let i=0; i<ids.length; i+=200) {
                try {
                    const d = await fetchJson(`${base}/song/detail?ids=${ids.slice(i, i+200).join(',')}`);
                    if(d.songs) songs = songs.concat(d.songs.map(s => ({...s, source: 'WY'})));
                } catch(e){}
                setProgress(((i + 200) / ids.length) * 50);
            }
            return songs;
        }

        async function fetchNeteaseOmni(kw) {
            const base = workingApiUrl || await getWorkingApi();
            const ids = new Set();
            const p1 = fetchJson(`${base}/search?keywords=${encodeURIComponent(kw)}&type=1&limit=50`).then(r => r.result?.songs?.forEach(s => ids.add(s.id)));
            const p2 = fetchJson(`${base}/search?keywords=${encodeURIComponent(kw)}&type=100&limit=3`).then(async r => {
                if(r.result?.artists) for(let a of r.result.artists) {
                    const ar = await fetchJson(`${base}/artist/songs?id=${a.id}&limit=50&order=time`);
                    ar.songs?.forEach(s => ids.add(s.id));
                }
            });
            await Promise.allSettled([p1,p2]);
            const uIds = Array.from(ids);
            if(!uIds.length) return [];
            
            let songs = [];
            for(let i=0; i<uIds.length; i+=200) {
                try {
                    const d = await fetchJson(`${base}/song/detail?ids=${uIds.slice(i, i+200).join(',')}`);
                    if(d.songs) songs = songs.concat(d.songs.map(s => ({...s, source: 'WY'})));
                } catch(e){}
            }
            return songs;
        }

        async function fetchQQOmni(kw, targetM, targetD) {
            const searchUrl = `https://c.y.qq.com/soso/fcgi-bin/client_search_cp?w=${encodeURIComponent(kw)}&n=30&page=1&format=json`;
            const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(searchUrl)}`;
            
            try {
                const r = await fetch(proxy);
                const data = await r.json();
                const json = JSON.parse(data.contents);
                const rawList = json.data?.song?.list || [];
                let candidates = [];
                for(let song of rawList) {
                    let obj = {
                        id: 'qq_' + song.songmid,
                        name: song.songname,
                        ar: song.singer,
                        al: { picUrl: `https://y.gtimg.cn/music/photo_new/T002R300x300M000${song.albummid}.jpg`, name: song.albumname },
                        source: 'QQ',
                        albummid: song.albummid,
                        publishTime: 0
                    };
                    candidates.push(obj);
                }

                const matchedSongs = [];
                const chunkSize = 5;
                for (let i=0; i<candidates.length; i+=chunkSize) {
                    const batch = candidates.slice(i, i+chunkSize);
                    await Promise.all(batch.map(async (s) => {
                        if(!s.albummid) return;
                        try {
                            const albumUrl = `https://c.y.qq.com/v8/fcg-bin/fcg_v8_album_info_cp.fcg?albummid=${s.albummid}&format=json`;
                            const aProxy = `https://api.allorigins.win/get?url=${encodeURIComponent(albumUrl)}`;
                            const ar = await fetch(aProxy);
                            const ad = await ar.json();
                            const aj = JSON.parse(ad.contents);
                            if(aj.data && aj.data.aDate) {
                                const [y, m, d] = aj.data.aDate.split('-');
                                if(parseInt(m) === targetM && parseInt(d) === targetD) {
                                    s.publishTime = new Date(aj.data.aDate).getTime();
                                    s.realYear = y;
                                    matchedSongs.push(s);
                                }
                            }
                        } catch(e) {}
                    }));
                }
                return matchedSongs;

            } catch(e) { return []; }
        }

        function getChinaDate(ts) {
            if (!ts || ts <= 0) return { m: null, d: null, y: null };
            if (String(ts).length < 13) ts *= 1000;
            const d = new Date(ts + 28800000);
            return { y: d.getUTCFullYear(), m: d.getUTCMonth()+1, d: d.getUTCDate() };
        }

        async function handleSearch() {
            const dStr = document.getElementById('date-input').value.trim();
            const param = document.getElementById('param-input').value.trim();
            const [mStr, dStr2] = dStr.split('-');
            const tm = parseInt(mStr); const td = parseInt(dStr2);

            const btn = document.getElementById('btn-submit');
            const stage = document.getElementById('stage');
            const list = document.getElementById('result-list');

            if(!param) {
                list.innerHTML = `<div style="text-align:center; margin-top:120px; color:#ffcc00; font-family:monospace;">PLEASE INPUT KEYWORD</div>`;
                stage.classList.add('expanded');
                return;
            }

            if(!tm || !td) { setStatus("Invalid Date"); return; }

            btn.disabled = true;
            btn.innerText = "Scanning...";
            stage.classList.add('expanded');
            list.innerHTML = '<div style="text-align:center; margin-top:120px; color:#555; font-family:monospace;">// DUAL ENGINE START //</div>';

            setLoadingState(true); 
            setProgress(5);

            try {
                let finalResults = [];

                if(currentMode === 1) {
                    setStatus("Engine: WY_PL");
                    const songs = await fetchNeteasePlaylist(param);
                    finalResults = songs.filter(s => {
                        let ts = (s.al && s.al.publishTime) ? s.al.publishTime : (s.publishTime || s.createTime);
                        if(!ts || ts <= 0) return false;
                        const d = getChinaDate(ts);
                        return d.m === tm && d.d === td;
                    }).map(s => ({...s, year: getChinaDate((s.al?.publishTime)||s.publishTime).y}));

                } else {
                    setStatus("Engine: DUAL");
                    
                    const neteasePromise = fetchNeteaseOmni(param).then(songs => {
                        return songs.filter(s => {
                            let ts = (s.al && s.al.publishTime) ? s.al.publishTime : (s.publishTime || s.createTime);
                            if(!ts || ts <= 0) return false;
                            const d = getChinaDate(ts);
                            return d.m === tm && d.d === td;
                        }).map(s => ({...s, year: getChinaDate((s.al?.publishTime)||s.publishTime).y}));
                    });

                    const qqPromise = fetchQQOmni(param, tm, td).then(songs => {
                        return songs.map(s => ({...s, year: s.realYear}));
                    });

                    const [wyRes, qqRes] = await Promise.allSettled([neteasePromise, qqPromise]);
                    if(wyRes.status === 'fulfilled') finalResults = finalResults.concat(wyRes.value);
                    if(qqRes.status === 'fulfilled') finalResults = finalResults.concat(qqRes.value);
                }

                const seen = new Set();
                const unique = [];
                finalResults.forEach(s => { if(!seen.has(s.id)) { seen.add(s.id); unique.push(s); } });
                unique.sort((a,b) => b.year - a.year);

                list.innerHTML = '';
                if(unique.length > 0) {
                    setStatus("SYNC COMPLETE", unique.length);
                    unique.forEach(s => {
                        const ar = (s.ar || s.artists || [{name:'?'}]).map(a=>a.name).join(', ');
                        const pic = (s.al && s.al.picUrl) ? s.al.picUrl : 'https://p1.music.126.net/6y-UleORITEDbvrOLV0Q8A==/5639395138885805.jpg';
                        
                        const copyText = `${s.name} - ${ar}`.replace(/'/g, "\\'");
                        const safeTitle = s.name.replace(/'/g, "\\'");
                        const safeArtist = ar.replace(/'/g, "\\'");
                        const yearClass = s.source === 'QQ' ? 'year-qq' : 'year-wy';

                        list.innerHTML += `
                        <div class="song-card">
                            <div class="cover-wrapper" onclick="openCoverModal('${pic}', '${safeTitle}', '${safeArtist}')">
                                <img src="${pic}?param=100y100" class="album-art" onerror="this.style.backgroundColor='#333'">
                            </div>
                            <div class="song-meta" onclick="copyToClipboard('${copyText}', this.parentElement)">
                                <div class="s-title" title="${s.name}">${s.name}</div>
                                <div class="s-artist">${ar}</div>
                            </div>
                            <div class="s-year ${yearClass}">${s.year}</div>
                            <div class="copy-toast">COPIED</div>
                        </div>`;
                    });
                } else {
                    setStatus("NO DATA", "0");
                    list.innerHTML = `<div style="text-align:center; margin-top:120px; color:#555; font-family:monospace;">// NULL RESULT //<br>TRY OTHER KEYWORDS</div>`;
                }

            } catch(e) {
                setStatus("ERROR");
                list.innerHTML = `<div style="text-align:center; margin-top:120px; color:#ff3333; font-family:monospace;">SYSTEM FAILURE<br>${e.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerText = "Pill";
                setLoadingState(false);
                setProgress(0);
            }
        }
    </script>
</body>
</html>